{% extends 'base.html' %}

{% block title %}GearGuard | Maintenance Dashboard{% endblock %}

{% block head %}
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",
            glow: "0 0 0 1px rgba(59, 130, 246, 0.5), 0 1px 3px 0 rgba(0, 0, 0, 0.1)"
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block page_header %}{% comment %}Header removed per request; page uses base header now.{% endcomment %}{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

  <!-- ================= KPI CARDS ================= -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 animate-fade-in">
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 hover:scale-105 transition-all duration-300 border border-white/50">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Total Equipment</p>
          <h2 id="kpi-equipment" class="text-3xl font-bold text-gray-900 mt-1">0</h2>
        </div>
        <i class="fas fa-tools text-blue-500 text-3xl opacity-75"></i>
      </div>
    </div>

    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 hover:scale-105 transition-all duration-300 border border-white/50">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Total Requests</p>
          <h2 id="kpi-requests" class="text-3xl font-bold text-gray-900 mt-1">0</h2>
        </div>
        <i class="fas fa-clipboard-list text-indigo-500 text-3xl opacity-75"></i>
      </div>
    </div>

    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 hover:scale-105 transition-all duration-300 border border-white/50 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">In Progress</p>
          <h2 id="kpi-progress" class="text-3xl font-bold text-blue-600 mt-1">0</h2>
        </div>
        <i class="fas fa-spinner fa-spin text-blue-500 text-3xl opacity-75"></i>
      </div>
    </div>

    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 hover:scale-105 transition-all duration-300 border border-white/50 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Overdue</p>
          <h2 id="kpi-overdue" class="text-3xl font-bold text-red-600 mt-1">0</h2>
        </div>
        <i class="fas fa-exclamation-triangle text-red-500 text-3xl opacity-75"></i>
      </div>
    </div>

    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 hover:scale-105 transition-all duration-300 border border-white/50">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Scrap</p>
          <h2 id="kpi-scrap" class="text-3xl font-bold text-gray-600 mt-1">0</h2>
        </div>
        <i class="fas fa-trash-alt text-gray-500 text-3xl opacity-75"></i>
      </div>
    </div>
  </section>

  <!-- ================= CHART & ACTIONS ================= -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-slide-up">
    <!-- Chart -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 lg:col-span-2 border border-white/50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
            <i class="fas fa-chart-pie text-indigo-500"></i>
            <span>Maintenance Status</span>
          </h3>
          <p class="text-sm text-gray-500 mt-1">Overview of request stages</p>
        </div>
        <button id="refreshChart" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-200 flex items-center space-x-1 text-sm">
          <i class="fas fa-sync-alt"></i>
          <span>Refresh</span>
        </button>
      </div>
      <div class="relative h-[350px] flex items-center justify-center">
        <canvas id="statusChart" class="w-full h-full block"></canvas>
      </div>
      <div id="chartLegend" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"></div>
    </div>

    <!-- Actions -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 space-y-4 border border-white/50 animate-slide-up">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <i class="fas fa-bolt text-yellow-500"></i>
        <span>Quick Actions</span>
      </h3>
      <a href="{% url 'profile' %}"
   class="w-full block py-3 px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl
          hover:from-blue-600 hover:to-blue-700 transition-all duration-300 text-center shadow-soft
          hover:shadow-glow flex items-center justify-center space-x-2">
  <i class="fas fa-user"></i>
  <span>Profile</span>
</a>

<a href="{% url 'settings' %}"
   class="w-full block py-3 px-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl
          hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 text-center shadow-soft
          hover:shadow-glow flex items-center justify-center space-x-2">
  <i class="fas fa-cog"></i>
  <span>Settings</span>
</a>

      <a href="{% url 'equipment_add' %}" class="w-full block py-3 px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 text-center shadow-soft hover:shadow-glow flex items-center justify-center space-x-2">
        <i class="fas fa-plus"></i>
        <span>Add Equipment</span>
      </a>
      <a href="{% url 'maintenance_add' %}" class="w-full block py-3 px-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 text-center shadow-soft hover:shadow-glow flex items-center justify-center space-x-2">
        <i class="fas fa-clipboard-check"></i>
        <span>New Request</span>
      </a>
      <a href="{% url 'kanban_board' %}" class="w-full block py-3 px-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-300 text-center shadow-soft hover:shadow-glow flex items-center justify-center space-x-2">
        <i class="fas fa-calendar-alt"></i>
        <span>Calendar</span>
      </a>
      <a href="{% url 'team_list' %}" class="w-full block py-3 px-4 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-xl hover:from-gray-700 hover:to-gray-800 transition-all duration-300 text-center shadow-soft hover:shadow-glow flex items-center justify-center space-x-2">
        <i class="fas fa-users"></i>
        <span>Teams</span>
      </a>
    </div>
  </section>

  <!-- ================= TABLES ================= -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-slide-up">
    <!-- Overdue -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 overflow-x-auto border border-white/50">
      <h3 class="text-lg font-semibold text-red-600 mb-4 flex items-center space-x-2">
        <i class="fas fa-clock text-red-500"></i>
        <span>Overdue Maintenance</span>
      </h3>
      <table class="w-full text-sm">
        <thead class="bg-gray-50/50">
          <tr>
            <th class="p-3 text-left font-medium text-gray-700">Equipment</th>
            <th class="p-3 text-left font-medium text-gray-700">Technician</th>
            <th class="p-3 text-left font-medium text-gray-700">Due Date</th>
          </tr>
        </thead>
        <tbody id="overdueTable" class="divide-y divide-gray-200"></tbody>
      </table>
      <div id="noOverdue" class="text-center py-8 text-gray-500 hidden">
        <i class="fas fa-check-circle text-4xl text-green-400 mb-2"></i>
        <p>No overdue items</p>
      </div>
    </div>

    <!-- Upcoming -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 border border-white/50">
      <h3 class="text-lg font-semibold text-green-600 mb-4 flex items-center space-x-2">
        <i class="fas fa-calendar-check"></i>
        <span>Upcoming Preventive Maintenance</span>
      </h3>
      <ul id="upcomingList" class="space-y-3 text-sm divide-y divide-gray-200"></ul>
    </div>
  </section>

  <!-- ================= TEAM WORKLOAD ================= -->
  <section class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-soft p-6 border border-white/50 animate-slide-up">
    <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center space-x-2">
      <i class="fas fa-user-friends text-purple-500"></i>
      <span>Team Workload</span>
    </h3>
    <div id="teamWorkload" class="grid grid-cols-1 sm:grid-cols-3 gap-6"></div>
  </section>

</main>

{% endblock %}

{% block scripts %}
<script>
  const data = {
    equipment: 120,
    requests: 78,
    inProgress: 22,
    overdue: 6,
    scrap: 3,

    status: [18, 22, 35, 3],

    overdueList: [
      { eq: "CNC Machine A-101", tech: "Amit Kumar", date: "Dec 12, 2025" },
      { eq: "Industrial Printer X-45", tech: "Ravi Sharma", date: "Dec 14, 2025" },
      { eq: "Hydraulic Press B-202", tech: "Priya Singh", date: "Dec 15, 2025" },
      { eq: "Conveyor Belt Sys-3", tech: "John Doe", date: "Dec 16, 2025" }
    ],

    upcoming: [
      { eq: "Backup Generator G-001", date: "Jan 18, 2026" },
      { eq: "HVAC Unit AC-05", date: "Jan 20, 2026" },
      { eq: "Data Server Rack-7", date: "Jan 22, 2026" },
      { eq: "Elevator Lift E-2", date: "Jan 25, 2026" }
    ],

    teams: {
      Mechanical: { count: 15, color: 'blue' },
      Electrical: { count: 9, color: 'green' },
      IT: { count: 6, color: 'purple' }
    }
  };

  // KPI
  kpi("kpi-equipment", data.equipment);
  kpi("kpi-requests", data.requests);
  kpi("kpi-progress", data.inProgress);
  kpi("kpi-overdue", data.overdue);
  kpi("kpi-scrap", data.scrap);

  function kpi(id, value) {
    document.getElementById(id).innerText = value.toLocaleString();
  }

  // Tables
  const overdueTable = document.getElementById("overdueTable");
  if (data.overdueList.length > 0) {
    overdueTable.innerHTML = data.overdueList.map(i => `
      <tr class="hover:bg-gray-50 transition-colors duration-200">
        <td class="p-3 font-medium text-gray-900">${i.eq}</td>
        <td class="p-3 text-gray-700">${i.tech}</td>
        <td class="p-3 text-red-600 font-semibold">${i.date}</td>
      </tr>`).join("");
  } else {
    document.getElementById("noOverdue").classList.remove("hidden");
  }

  document.getElementById("upcomingList").innerHTML =
    data.upcoming.map(i => `
      <li class="py-3 px-0 flex items-center gap-3">
        <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full"></div>
        <span class="text-gray-900 font-medium">${i.eq}</span>
        <span class="text-gray-500 ml-auto">${i.date}</span>
      </li>
    `).join("");

  document.getElementById("teamWorkload").innerHTML =
    Object.entries(data.teams).map(([t, info]) => `
      <div class="text-center p-4 bg-gradient-to-b from-white to-gray-50 rounded-xl border border-gray-200 hover:shadow-glow transition-all duration-300">
        <i class="fas fa-users-cog text-${info.color}-500 text-3xl mb-2"></i>
        <p class="text-gray-500 font-medium">${t}</p>
        <h4 class="text-2xl font-bold text-gray-900">${info.count} Tasks</h4>
        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
          <div class="bg-${info.color}-500 h-2 rounded-full" style="width: ${(info.count / 20) * 100}%"></div>
        </div>
      </div>`).join("");

  // Chart with dynamic data and professional visuals
  const ctx = document.getElementById('statusChart').getContext('2d');

  // Enhanced plugin for center label with better styling
  const centerTextPlugin = {
    id: 'centerText',
    afterDraw: (chart) => {
      if (!chart.data.datasets[0].data.some(d => d > 0)) return;
      const {ctx, chartArea: {left, right, top, bottom, width, height}} = chart;
      const centerX = (left + right) / 2;
      const centerY = (top + bottom) / 2;
      ctx.save();
      ctx.fillStyle = '#1f2937'; // gray-800
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.font = 'bold 20px Inter, sans-serif';
      const total = chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
      ctx.fillText(`${total.toLocaleString()} Requests`, centerX, centerY - 10);
      ctx.font = '400 12px Inter, sans-serif';
      ctx.fillStyle = '#6b7280'; // gray-500
      ctx.fillText('Total Overview', centerX, centerY + 15);
      ctx.restore();
    }
  };

  const statusLabels = ["New", "In Progress", "Repaired", "Scrap"];
  const statusColors = ['#f59e0b', '#3b82f6', '#10b981', '#6b7280']; // Amber, Blue, Emerald, Gray

  // Create radial gradients for segments
  function createGradients(ctx, width, height) {
    return statusColors.map(color => {
      const gradient = ctx.createRadialGradient(width/2, height/2, 0, width/2, height/2, Math.max(width, height)/2);
      gradient.addColorStop(0, color + 'CC'); // Semi-transparent outer
      gradient.addColorStop(1, color + 'FF'); // Opaque inner
      return gradient;
    });
  }

  const statusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: [0,0,0,0],
        backgroundColor: statusColors,
        borderColor: '#ffffff',
        borderWidth: 3,
        hoverOffset: 12,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: 'white',
          bodyColor: 'white',
          callbacks: {
            label: (ctx) => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = ((ctx.parsed / total) * 100).toFixed(1);
              return `${ctx.label}: ${ctx.parsed} (${pct}%)`;
            }
          }
        },
        legend: { display: false }
      },
      animation: { 
        animateRotate: true,
        duration: 1000,
        easing: 'easeOutQuart'
      }
    },
    plugins: [centerTextPlugin]
  });

  // Enhanced legend with icons and better spacing
  function renderLegend(counts) {
    const total = counts.reduce((a,b)=>a+b,0) || 1;
    const container = document.getElementById('chartLegend');
    container.innerHTML = statusLabels.map((label, i) => {
      const count = counts[i] || 0;
      const pct = ((count / total) * 100).toFixed(0);
      return `
        <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 transition-colors duration-200">
          <div class="flex-shrink-0 w-4 h-4 rounded-full" style="background-color: ${statusColors[i]}"></div>
          <div class="flex-1">
            <span class="font-medium text-gray-900">${label}</span>
          </div>
          <span class="text-sm text-gray-600">${count} <span class="text-xs">(${pct}%)</span></span>
        </div>
      `;
    }).join('');
  }

  // Fetch data from Kanban API and update chart
  async function fetchAndUpdateChart() {
    const api = '/maintenance/api/kanban/';
    const refreshBtn = document.getElementById('refreshChart');
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    try {
      const res = await fetch(api, {credentials: 'same-origin'});
      if (!res.ok) throw new Error('API error');
      const grouped = await res.json();
      const counts = [
        (grouped.new || []).length,
        (grouped.in_progress || []).length,
        (grouped.repaired || []).length,
        (grouped.scrap || []).length
      ];
      // Update gradients based on new size
      const {width, height} = ctx.canvas;
      statusChart.data.datasets[0].backgroundColor = createGradients(ctx, width, height);
      statusChart.data.datasets[0].data = counts;
      statusChart.update('none'); // Smooth update
      renderLegend(counts);
    } catch (err) {
      console.warn('Kanban API failed, using local sample data', err);
      const {width, height} = ctx.canvas;
      statusChart.data.datasets[0].backgroundColor = createGradients(ctx, width, height);
      statusChart.data.datasets[0].data = data.status;
      statusChart.update('none');
      renderLegend(data.status);
    } finally {
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
      refreshBtn.disabled = false;
    }
  }

  // Fetch additional dashboard metrics (KPIs, overdue lists, teams)
  async function fetchDashboardData() {
    try {
      const res = await fetch('/maintenance/api/dashboard/', {credentials: 'same-origin'});
      if (!res.ok) throw new Error('API error');
      const d = await res.json();

      // KPIs
      kpi('kpi-equipment', d.equipment);
      kpi('kpi-requests', d.requests);
      kpi('kpi-progress', d.inProgress);
      kpi('kpi-overdue', d.overdue);
      kpi('kpi-scrap', d.scrap);

      // Overdue table
      const overdueTable = document.getElementById('overdueTable');
      if (d.overdueList && d.overdueList.length > 0) {
        overdueTable.innerHTML = d.overdueList.map(i => `
          <tr class="hover:bg-gray-50 transition-colors duration-200">
            <td class="p-3 font-medium text-gray-900">${i.eq}</td>
            <td class="p-3 text-gray-700">${i.tech || '-'}</td>
            <td class="p-3 text-red-600 font-semibold">${new Date(i.date).toLocaleDateString()}</td>
          </tr>`).join('');
        document.getElementById('noOverdue').classList.add('hidden');
      } else {
        document.getElementById('noOverdue').classList.remove('hidden');
        overdueTable.innerHTML = '';
      }

      // Upcoming
      document.getElementById('upcomingList').innerHTML = (d.upcoming || []).map(i => `
        <li class="py-3 px-0 flex items-center gap-3">
          <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full"></div>
          <span class="text-gray-900 font-medium">${i.eq}</span>
          <span class="text-gray-500 ml-auto">${new Date(i.date).toLocaleDateString()}</span>
        </li>`).join('');

      // Teams
      const workload = document.getElementById('teamWorkload');
      workload.innerHTML = Object.entries(d.teams || {}).map(([t, info]) => `
        <div class="text-center p-4 bg-gradient-to-b from-white to-gray-50 rounded-xl border border-gray-200 hover:shadow-glow transition-all duration-300">
          <i class="fas fa-users-cog text-indigo-500 text-3xl mb-2"></i>
          <p class="text-gray-500 font-medium">${t}</p>
          <h4 class="text-2xl font-bold text-gray-900">${info.count} Tasks</h4>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div class="bg-indigo-500 h-2 rounded-full" style="width: ${Math.min(100, (info.count / Math.max(1, d.requests)) * 100)}%"></div>
          </div>
        </div>`).join('');

    } catch (err) {
      console.warn('Dashboard API failed, using sample data', err);
    }
  }

  // Wire refresh button to update chart and dashboard metrics
  document.getElementById('refreshChart').addEventListener('click', ()=>{ fetchAndUpdateChart(); fetchDashboardData(); });

  // Initial load with animation delay (chart + KPIs)
  setTimeout(()=>{ fetchAndUpdateChart(); fetchDashboardData(); }, 300);

  // Responsive chart resize
  window.addEventListener('resize', () => {
    statusChart.resize();
    const {width, height} = ctx.canvas;
    statusChart.data.datasets[0].backgroundColor = createGradients(ctx, width, height);
    statusChart.update('none');
  });
</script>
{% endblock %}
