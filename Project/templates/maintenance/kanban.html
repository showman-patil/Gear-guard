{% extends 'base.html' %}

{% block title %}Maintenance Kanban â€” GearGuard{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
  <div>
    <h1 class="text-3xl font-bold text-gray-800">ðŸ§© Maintenance Kanban</h1>
    <p class="text-sm text-gray-500 mt-1">Real-time workflow for maintenance lifecycle</p>
  </div>

  <div class="flex gap-3">
    <a href="/maintenance/add/" class="px-4 py-2 rounded-md bg-indigo-600 text-white">+ New Request</a>
    <a href="/" class="px-3 py-1 rounded-md bg-gray-100">Dashboard</a>
  </div>
</div>

<div id="authNotice" class="mb-4 hidden">
  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-lg text-yellow-800">Sign in to update request statuses â€” <a href="/accounts/login/?next=/maintenance/kanban/" class="underline">Login</a></div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-blue-600 font-semibold">New</h2>
      <span id="count-new" class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0</span>
    </div>
    <div id="col-new" data-status="new" class="space-y-3"></div>
  </div>

  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-yellow-600 font-semibold">In Progress</h2>
      <span id="count-in_progress" class="text-xs bg-yellow-100 text-yellow-600 px-2 py-0.5 rounded-full">0</span>
    </div>
    <div id="col-in_progress" data-status="in_progress" class="space-y-3"></div>
  </div>

  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-green-600 font-semibold">Repaired</h2>
      <span id="count-repaired" class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded-full">0</span>
    </div>
    <div id="col-repaired" data-status="repaired" class="space-y-3"></div>
  </div>

  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-red-600 font-semibold">Scrap</h2>
      <span id="count-scrap" class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">0</span>
    </div>
    <div id="col-scrap" data-status="scrap" class="space-y-3"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');
const apiUrl = '/maintenance/api/kanban/';
const updateUrl = id => `/maintenance/api/requests/${id}/status/`;

function createCard(item) {
  const el = document.createElement('div');
  el.className = 'kanban-card';
  el.dataset.id = item.id;
  el.innerHTML = `
    <div class="flex justify-between items-start">
      <div>
        <h3 class="font-semibold text-sm text-gray-800">${item.title}</h3>
        <p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-laptop mr-1"></i>${item.equipment.name}</p>
        ${item.description ? `<p class="text-xs text-gray-600 mt-2">${item.description}</p>` : ''}
      </div>
      <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-lg">#${item.id}</span>
    </div>
  `;
  return el;
}

async function loadKanban() {
  const res = await fetch(apiUrl, {credentials: 'same-origin'});
  const authNotice = document.getElementById('authNotice');
  if (res.status === 403) { authNotice.classList.remove('hidden'); return; }
  authNotice.classList.add('hidden');
  if (!res.ok) return console.error('Failed to load kanban');
  const data = await res.json();

  ['new','in_progress','repaired','scrap'].forEach(status => {
    const col = document.getElementById('col-' + status);
    const count = document.getElementById('count-' + status);
    col.innerHTML = '';
    count.innerText = data[status]?.length || 0;
    if (!data[status]?.length) { col.innerHTML = `<div class="empty">No items here</div>`; }
    data[status]?.forEach(item => col.appendChild(createCard(item)));

    new Sortable(col, {
      group: 'kanban', animation: 200, ghostClass: 'ghost', onEnd: async evt => {
        const id = evt.item.dataset.id; const newStatus = evt.to.dataset.status;
        try {
          const patch = await fetch(updateUrl(id), { method: 'PATCH', credentials: 'same-origin', headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({status:newStatus}) });
          if (!patch.ok) { console.error('Failed to update status', await patch.text()); loadKanban(); return; }
          loadKanban();
        } catch (e) { console.error(e); loadKanban(); }
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', loadKanban);
</script>
{% endblock %}
