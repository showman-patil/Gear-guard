{% extends 'base.html' %}

{% block title %}GearGuard | Profile{% endblock %}

{% block page_header %}
  <div class="card p-4 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-lg font-bold">üë§ Profile</h1>
        <p class="text-sm text-muted hidden sm:block">View and update your account details</p>
      </div>
      <a href="/" class="text-sm text-gray-600 hover:text-gray-800">‚Üê Back to Dashboard</a>
    </div>
  </div>
{% endblock %}

{% block content %}
<main class="container mt-4 space-y-8">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Profile Card -->
    <div class="card p-6">
      <div class="flex items-center gap-4">
        <div id="avatar" class="w-20 h-20 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-2xl">
          {{ user_obj.first_name|default:user_obj.username|slice:":1"|upper }}
        </div>
        <div>
          <h2 id="displayName" class="text-xl font-semibold">{{ user_obj.get_full_name|default:user_obj.username }}</h2>
          <p id="memberSince" class="text-sm text-muted">Member since {{ user_obj.date_joined|date:'F Y' }}</p>
        </div>
      </div>

      <div class="mt-6">
        <h3 class="text-sm text-muted font-medium">Contact</h3>
        <p class="mt-2 text-sm">Email: <span id="emailDisplay" class="text-gray-800 font-medium">{{ user_obj.email }}</span></p>
      </div>

      <div class="mt-6">
        <h3 class="text-sm text-muted font-medium">Teams</h3>
        <ul id="teamList" class="mt-2 space-y-2 text-sm text-gray-700">
          {% if teams %}
            {% for t in teams %}
              <li>{{ t.name }}</li>
            {% endfor %}
          {% else %}
            <li class="text-sm text-muted">No teams assigned</li>
          {% endif %}
        </ul>
      </div>

    </div>

    <!-- Edit form -->
    <div class="lg:col-span-2 card p-6">
      <h2 class="text-lg font-semibold mb-4">Profile Settings</h2>

      <div id="flash" class="hidden"></div>

      <form id="profileForm" class="space-y-4 max-w-2xl">
        {% csrf_token %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-600">First name</label>
            <input id="first_name" name="first_name" class="mt-1 w-full px-4 py-2 rounded-lg border border-gray-200" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Last name</label>
            <input id="last_name" name="last_name" class="mt-1 w-full px-4 py-2 rounded-lg border border-gray-200" />
          </div>
        </div>

        <div>
          <label class="block text-sm text-gray-600">Email</label>
          <input id="email" name="email" class="mt-1 w-full px-4 py-2 rounded-lg border border-gray-200" />
        </div>

        <div class="flex items-center gap-3">
          <button id="saveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save changes</button>
          {% url 'password_change' as pwd_url %}
          {% if pwd_url %}
            <a href="{{ pwd_url }}" class="text-sm text-gray-600 underline">Change password</a>
          {% endif %}
        </div>
      </form>

      <hr class="my-6">

      <div>
        <h3 class="text-md font-medium">Assigned Work</h3>
        <p class="text-sm text-muted mt-1">Open assignments</p>

        <div id="openList" class="mt-3 space-y-3"></div>
      </div>

      <div class="mt-6">
        <h3 class="text-md font-medium">Past assignments</h3>
        <div id="closedList" class="mt-3 space-y-2 text-sm text-gray-700"></div>
      </div>

    </div>

  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
// helper to read CSRF from cookies
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

async function loadProfile(){
  const res = await fetch('{% url "profile_api" %}');
  if(!res.ok) return;
  const data = await res.json();
  document.getElementById('first_name').value = data.first_name || '';
  document.getElementById('last_name').value = data.last_name || '';
  document.getElementById('email').value = data.email || '';
  document.getElementById('displayName').innerText = (data.first_name || data.username) + (data.last_name ? (' ' + data.last_name) : '');
  document.getElementById('emailDisplay').innerText = data.email || '';
  const teamList = document.getElementById('teamList');
  teamList.innerHTML = '';
  if(data.teams && data.teams.length){
    data.teams.forEach(t => { const li = document.createElement('li'); li.innerText = t; teamList.appendChild(li); });
  } else {
    teamList.innerHTML = '<li class="text-sm text-muted">No teams assigned</li>';
  }

  // render lists
  const openList = document.getElementById('openList');
  openList.innerHTML = '';
  (data.assigned_open || []).forEach(r => {
    const el = document.createElement('div');
    el.className = 'border rounded-lg p-3 flex justify-between items-start';
    el.innerHTML = `<div><div class="text-sm font-medium">${r.title}</div><div class="text-xs text-muted">Status: ${r.status}</div></div><div class="text-xs text-muted">${new Date(r.created_at).toLocaleDateString()}</div>`;
    openList.appendChild(el);
  });

  const closedList = document.getElementById('closedList');
  closedList.innerHTML = '';
  (data.assigned_closed || []).forEach(r => {
    const el = document.createElement('div');
    el.className = 'border rounded-lg p-2 flex justify-between';
    el.innerHTML = `<div>${r.title} <span class="text-xs text-muted">‚Äì ${r.status}</span></div><div class="text-xs text-muted">${new Date(r.created_at).toLocaleDateString()}</div>`;
    closedList.appendChild(el);
  });
}

document.getElementById('profileForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    first_name: document.getElementById('first_name').value,
    last_name: document.getElementById('last_name').value,
    email: document.getElementById('email').value
  };
  const res = await fetch('{% url "profile_api" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(payload)
  });
  const flash = document.getElementById('flash');
  if(res.ok){
    flash.className = 'p-3 rounded bg-green-500 text-white'; flash.innerText = 'Profile updated'; flash.classList.remove('hidden');
    setTimeout(()=>flash.classList.add('hidden'),1500);
    await loadProfile();
  } else {
    flash.className = 'p-3 rounded bg-red-500 text-white'; flash.innerText = 'Update failed'; flash.classList.remove('hidden');
    setTimeout(()=>flash.classList.add('hidden'),1500);
  }
});

// initial load
loadProfile();
</script>
{% endblock %}
